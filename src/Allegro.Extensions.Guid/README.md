# Allegro.Extensions.Guid

NET library that provides a Twitter Snowflake-alike ID generator for .NET. It is based on the IP address and network
mask and is designed to offer low-latency, distributed, time-ordered, compact, and highly available ID generation. This
library is based on [IdGen](https://github.com/RobThree/IdGen) project and serves as a basis for generating unique identifiers.


## Introduction

The FGuid identifiers are generated based on the combination of IP address, network mask, and cluster number. It
utilizes the last bits of the IP address to ensure uniqueness, taking into account the
timestamp and other factors. Here's a breakdown of how this works:

1. Our machine address is `10.127.128.116/21`, and it is represented in binary as: `00001010011111111000000001110100`.
2. Skipping bits based on the netmask results in: `00001110100`.
3. By default, there's no bit shifting, so the value remains `116`.
4. The generator ID is derived by taking `116 % MaxGenerators` (where MaxGenerators is `2^(11+2) = 8192`).
5. The final FGuid is generated by encoding the calculated values. It might look like this:
   `0010000001001111101011011001011100011100000000011101000000000000`, which is equivalent to the decimal value `2328270396895383552`.

## Getting Started

To generate an FGuid:

```csharp
// As a string
string fguid = FGuid.Generate();

// As a long
long fguid = FGuid.GenerateLong();

// As an struct - similarly to "Guid.NewGuid()"
FGuid fguid = FGuid.NewGuid();
```

To parse

```csharp
string fguidString = "1234567890"; // replace with your FGuid string
FGuid parsedFGuid = FGuid.Parse(fguidString);
```

## Environment Setup

If you choose not to customize the generator's configuration, the library will use the default settings described below.
You can retrieve the formatted configuration using the `FGuid.GetFormattedConfiguration` method. It will display the
configured generator ID, IP address, and network mask if provided. The length of FGuids depends on the configured
settings.

```
GeneratorId: 2305,
Options: { 
    IdStructure = { 
        TimestampBits = 40, GeneratorIpBits = 11, GeneratorClusterBits = 2, SequenceBits = 10
    },
    Machine = { 
        Ip = 192.168.1.1, Netmask = 20, ClusterNumber = 1
    }
}
```

By default, the library uses the following settings:
- TimestampBits: 40
- GeneratorIpBits: 11
- GeneratorClusterBits: 2
- SequenceBits: 10
- **IP: Obtained from the `Pod__Ip__Address` environment variable** - this is required
- Default Netmask: 21 (can be overridden with the `Ip__Netmask` environment variable)
- Default Cluster Number: 0 (can be overridden with the `Cluster__Number` environment variable)

You can customize these settings by using the GeneratorOptions and GeneratorMachineOptions structures and the FGuid.SetOptions method. Make sure to configure these settings before generating any FGuids.

#### Kubernetes setup

The easiest way is to add an environment variable so that all pods use it (k8s does not expose ip by default):

```yaml
- name: Pod__Ip__Address
  valueFrom:
    fieldRef:
      fieldPath: status.podIP
```

## Customization

You can customize the generator's configuration (optional - default is provided):

```csharp
var options = new GeneratorOptions(
    new GeneratorIdStructureOptions( // <--- if you want more control
        TimestampBits: 40,
        GeneratorIpBits: 11,
        GeneratorClusterBits: 2,
        SequenceBits: 10),
    new GeneratorMachineOptions( // <--- specific to the machine
        Ip: "127.0.0.1",
        Netmask: 24,
        ClusterNumber: 1));

FGuid.SetOptions(options);
```